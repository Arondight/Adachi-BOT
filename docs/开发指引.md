# 开发指引

## 目录结构

```
Adachi-BOT
├── app.js                      # 主程序
├── config
│   ├── artifacts.yml           # 圣遗物配置
│   ├── command.yml             # 命令入口
├── data
│   ├── db                      # 数据库文件
│   ├── font
│   └── js
├── docs
├── resources
├── resources_custom
└── src
    ├── plugins                 # 插件
    ├── utils                   # 库
    └── views                   # HTML
```

## 插件开发

1. 在 `src/plugins` 目录下创建插件目录。
2. 在 `config/command.yml` 中添加命令入口。
3. 如有需要，在 `src/utils/init.js` 中加载数据库。

> 此处待完善。

## 数据库

在 `src/utils/database.js` 中使用 [lodash](https://github.com/lodash/lodash) 封装了 [lowdb](https://github.com/typicode/lowdb) 。

### 接口

#### 导入

```js
import db from "../../utils/database.js";
```

#### 初始化

初始化名称为 `name` 的数据库。如果数据库已存在，加载其数据；如果数据库不存在，创建空数据库。

`default` 默认设置为 `{ user: [] }` 。

```js
db.init(name: String, default?: Object);
```

> 在 src/utils/init.js 中使用，以便启动时初始化。

#### 写入磁盘

把数据库 `name` 的数据写入磁盘，**一般无须手动调用**。

```
db.write(name: String);
```

#### 键的存在性

在数据库 `name` 中判断 `path` 是否存在。

```js
db.has(name: String, ...path);
```

> 对应 `lodash.hasIn` 。

#### 值的存在性

在数据库 `name` 中的 `key` 对应的 Array 中，检测所有的索引 `index` 在是否包含值 `value` 。

```
db.includes(name: String, key: String, index: String, value: Any);
```

> 对应 `lodash.includes` 。

#### 获取数据

> | `index` | 返回值 |
> | --- | --- |
> | `undefined` | `key` 对应的 Array  |
> | `Object` | `key` 对应的 Array 中，获取包含索引 `index` 的对象 |

`index` 默认为 `undefined` 。

```
db.get(name: String, key: String, index?: Object);
```

> 对应 `lodash.get` 和 `lodash.find` 。

#### 写入数据

在数据库 `name` 中的 `key` 对应的 Array 中，插入一条数据 `data` 。

此方法自动调用 `db.write` 。

```
db.push(name: String, key: String, data: Object);
```

> 对应 `lodash.push` 。

#### 更新数据

在数据库 `name` 中的 `key` 对应的 Array 中，将包含索引 `index` 的对象更新为 `data` 。

此方法自动调用 `db.write` 。

> 只更新 `data` 中包含的 pair ，不会修改其他数据。

```
db.update(name: String, key: String, index: Object, data: Object);
```

> 对应 `lodash.assign` 。

#### 设置数据

把数据库 `name` 中的 `key` 对应的数据设置为 `data` 。

此方法自动调用 `db.write` 。

```
db.set(name: String, key: String, data: any);
```

> 对应 `lodash.set` 。

### 示例

```
import db from "../../utils/database.js";

await db.init("info");
await db.write("info");  // 几乎在任何情况下你都不需要手动调用 db.write
await db.has("info", "user", 0, "uid");
await db.includes("info", "user", uid);
await db.get("info", "user", { uid });
await db.get("info", "user");
await db.push("time", "user", { uid, time: 0 });
await db.update("music", "source", { ID: id }, { ...data, Source: source });
await db.set("gacha", "data", [indefinite, character, weapon]);
```
